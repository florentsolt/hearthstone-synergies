<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hearthstone Synergies</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/template.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/d3.min.js"></script>
    <script src="js/cards.js"></script>
    <script src="js/synergies.js"></script>

    <div class="navbar navbar-inverse" role="navigation">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">Hearthstone Synergies</a>
        </div>
        <div class="navbar-header navbar-right">
          <ul id="legend" class="nav navbar-nav">
          </ul>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="sidebar">
        <ul class="nav nav-sidebar" id="classes">
          <li><a href="#all" class="all">All</a></li>
        </ul>
        <div class="nav nav-sidebar">
          <a class="thumbnail">
            <img id="thumbnail" width="200" height="303" src="">
          </a>
        </div>
      </div>
      <svg id="app" class="main"></svg>
    </div>

    <script>

    $(function() {
      // Sizing
      var margin = 0,
        width = parseInt($("#app").width()) - margin*2,
        height = parseInt($("#app").outerHeight()) - margin*2;

      // Zoom behavior
      var zoom = d3.behavior.zoom()
        .scaleExtent([0.3, 2])
        .on("zoom", function() {
          svg.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
        });

      var dict = {};
      var classes = {};
      var links = [];

      // Build classes & dict
      for (var i=0; i<cards.length; i++) {
        dict[cards[i].id] = cards[i];
        classes[cards[i].class] = true;
      }

      // Init triggers & listeners
      var triggers = {};
      var listeners = {};
      for (var id in synergies) {
        triggers[id] = [];
        listeners[id] = [];
      }

      // Build triggers & listeners
      for (var id in cards_synergies) {
        var card = cards_synergies[id];
        if (card.trigger) {
          for (var i=0; i<card.trigger.length; i++) {
            triggers[card.trigger[i]].push(id);
          }
        }
        if (card.listen) {
          for (var i=0; i<card.listen.length; i++) {
            listeners[card.listen[i]].push(id);
          }
        }
      }

      // Build links
      for (var synergie in synergies) {
        $('#legend')
          .append($('<li></li>')
            .addClass(synergie)
            .html("<a>â€” " + synergie.replace('_', ' ') + "</a>")
          );
        for (var i=0; i<triggers[synergie].length; i++) {
          for (var j=0; j<listeners[synergie].length; j++) {
            var source = triggers[synergie][i],
              target = listeners[synergie][j];
            if (source != target) {
              links.push({
                source: dict[source],
                target: dict[target],
                synergie: synergie
              });
            }
          }
        }
      }

      // Build left menu
      classes = Object.keys(classes);
      for (var i=0; i<classes.length; i++) {
        var klass = classes[i];
        if (klass != 'neutral') {
          var title = klass.charAt(0).toUpperCase() + klass.slice(1)
          var a = $('<a>')
          .text(title)
          .attr('href', '#' + klass)
          .attr('class', klass)
          $("#classes").append($("<li></li>").append(a));
        }
      }

      // When click on the left menu
      $(window).on('hashchange', function() {
        var klass = window.location.hash.substring(1);
        noThumbnail();
        filter(klass);
      });

      // Main SVG object
      var svg = d3.select("#app")
        .call(zoom)
        .on("dblclick.zoom", null)
        .append('g');

      // Create 3 groups to prevent ovelapping
      svg.append('g').attr('class', 'paths');
      svg.append('g').attr('class', 'circles');
      svg.append('g').attr('class', 'texts');

      // D3 force layout
      var force = d3.layout.force()
        .nodes([])
        .links([])
        .linkDistance(150)
        .charge(-3000)
        .gravity(0.5)
        .size([width, height])
        .on('tick', tick);

      // Drag behavior
      var drag = force.drag()
        .on("dragstart", function(d) {
          d3.event.sourceEvent.stopPropagation();
        });

      // Build the arrow
      svg.append("svg:defs").selectAll("marker")
          .data(Object.keys(synergies))
          .enter().append("svg:marker")
          .attr("id", String)
          .attr("viewBox", "0 -5 10 10")
          .attr("refX", 20)
          .attr("refY", -1.5)
          .attr("markerWidth", 6)
          .attr("markerHeight", 6)
          .attr("orient", "auto")
          .append("svg:path")
          .attr("d", "M0,-5L10,0L0,5");
            
      var path, circle, text;

      function repaint() {
        path = svg.select(".paths")
          .selectAll("path.link")
          .data(force.links(), function(d) { return d.source.id + "-" + d.target.id; });
        path.enter().append("path")
          .attr("marker-end", function(d) { return "url(#" + d.synergie + ")"; })
          .attr("class", function(d) { return "link " + d.synergie; });
        path.exit().remove();

        circle = svg.select(".circles")
          .selectAll("circle")
          .data(force.nodes(), function(d) { return d.id;});
        circle.enter().append("circle")
          .attr("r", 7).attr("class", function(d) { return "circle " + d.class + " " + d.quality; })
          .on("click", select)
          .on("mouseover", thumbnail)
          .on("mouseout", noThumbnail)
          .call(drag);
        circle.exit().remove();

        text = svg.select('.texts')
          .selectAll("text")
          .data(force.nodes(), function(d) { return d.id;});
        text.enter().append("text")
          .attr("x", 15)
          .attr("y", ".35em")
          .attr("class", function(d) { return "text " + d.quality; })
          .attr("xlink:href", function(d) { if (d.class != "neutral") { return "/images/" + d.class + ".png"; }})
          .on("click", select)
          .on("mouseover", thumbnail)
          .on("mouseout", noThumbnail)
          .text(function(d) { return d.name; });
        text.exit().remove();

        force.start();
      }

      function tick() {
        path.attr("d", linkArc);
        circle.attr("transform", transform);
        text.attr("transform", transform);
      }

      function linkArc(d) {
        var dx = d.target.x - d.source.x,
        dy = d.target.y - d.source.y,
        dr = Math.sqrt(dx * dx + dy * dy);
        return "M" + d.source.x + "," + d.source.y + "A" + dr + "," + dr + " 0 0,1 " + d.target.x + "," + d.target.y;
      }

      function transform(d) {
        return "translate(" + d.x + "," + d.y + ")";
      }

      function thumbnail(d) {
        $('#thumbnail').attr('src', d.image);
        $('#thumbnail').parent().css('visibility', 'visible');
      }

      function noThumbnail(d) {
        var id = parseInt(window.location.hash.substring(1));
        if (id > 0) {
          thumbnail(dict[id]);
        } else {
          $('#thumbnail').parent().css('visibility', 'hidden');
          $('#thumbnail').attr('src', '');
        }
      }

      function select(d) {
        window.location = '#' + d.id + " " + d.name;
      }

      function filter(query) {
        var id = parseInt(query);
        $('#classes li.active').removeClass('active');

        // Only show a card
        if (id > 0) {
            thumbnail(dict[id]);
            var linked_with = {};
            var linked_with_links = [];
            for (var i=0; i<links.length; i++) {
              if (links[i].source.id == id) {
                linked_with[links[i].target.id] = true;
                linked_with_links.push(links[i]);
              } else if (links[i].target.id == id) {
                linked_with[links[i].source.id] = true;
                linked_with_links.push(links[i]);
              }
            }
            console.log(linked_with);
            force.nodes(cards.filter(function(card) {
              return card.id == id || linked_with[card.id];
            }));
            force.links(linked_with_links);

        } else {
          $('#classes li a.' + query).parent().addClass('active');
          // Show all classes
          if (query == 'all') {
            force.nodes(cards.filter(function(card) {
              return cards_synergies[card.id];
            }));
            force.links(links);
          } else {
            // Show only a class
            force.nodes(cards.filter(function(card) {
              return cards_synergies[card.id] && (card.class == query || card.class == 'neutral');
            }));
            force.links(links.filter(function(link) {
              return (link.source.class == query || link.source.class == 'neutral') &&
              (link.target.class == query || link.target.class == 'neutral');
            }));
          }
        }
        repaint();
      }

      filter(window.location.hash.substring(1) || 'all');
      repaint();
    });

    </script>
  </body>
</html>

